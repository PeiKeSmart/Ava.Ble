# JieLi OTA 故障排查指南

本文档帮助你诊断和解决 JieLi OTA 固件升级过程中可能遇到的常见问题。

## 📋 目录

- [设备扫描问题](#设备扫描问题)
- [连接问题](#连接问题)
- [升级失败](#升级失败)
- [回连失败](#回连失败)
- [性能问题](#性能问题)
- [应用程序问题](#应用程序问题)
- [日志分析](#日志分析)

---

## 设备扫描问题

### 扫描不到任何设备

**症状**: 点击"开始扫描"后,设备列表为空

**可能原因**:
1. Windows 蓝牙未开启
2. 蓝牙适配器驱动异常
3. 设备未开启或不在可发现状态
4. 设备距离过远

**解决方法**:

#### 检查 Windows 蓝牙状态

1. 打开 Windows 设置 → 蓝牙和其他设备
2. 确认蓝牙开关为 **"开"**
3. 如果显示为灰色,可能是驱动问题

#### 检查蓝牙适配器

```powershell
# PowerShell 命令检查蓝牙适配器
Get-PnpDevice -Class Bluetooth | Select-Object Status, FriendlyName
```

预期输出:
```
Status    FriendlyName
------    ------------
OK        Intel(R) Wireless Bluetooth(R)
```

如果显示 `Error` 或 `Unknown`,需要更新驱动:
- 设备管理器 → 蓝牙 → 右键更新驱动程序

#### 确认设备状态

- 设备已开机
- 设备处于配对模式 (通常长按电源键 3-5 秒)
- 设备未被其他应用连接

#### 调整扫描距离

- 将设备移到电脑附近 (< 2 米)
- 避免金属物体遮挡

### 扫描到设备但都是 Unknown

**症状**: 设备列表显示 `Unknown_XXXXXXXXX`

**原因**: 这是正常现象!很多蓝牙设备为了节省电量不广播设备名称。

**识别方法**:

1. **通过信号强度 (RSSI)**:
   - 将设备移近电脑
   - RSSI 值最大的通常是目标设备
   - 例如: -40 dBm 比 -80 dBm 更近

2. **通过 MAC 地址**:
   - 如果知道设备 MAC,可以直接匹配
   - MAC 格式: `Unknown_1234ABCD5678`

3. **通过设备类型前缀**:
   - `JL_XXX`: 杰理设备
   - `Apple_XXX`: Apple 设备
   - `Samsung_XXX`: Samsung 设备

### 扫描过程中应用卡死

**症状**: 点击"开始扫描"后应用无响应

**可能原因**:
1. 蓝牙驱动冲突
2. 系统资源不足

**解决方法**:

1. **重启应用**
2. **重启蓝牙适配器**:
   ```powershell
   # 以管理员身份运行
   Restart-Service bthserv
   ```
3. **更新蓝牙驱动**
4. **检查系统资源** (任务管理器)

---

## 连接问题

### 连接失败: 设备不可达

**症状**: 点击"开始升级"后提示"连接失败"

**诊断步骤**:

#### 1. 检查设备状态

```
日志: [ERROR] 连接设备失败: DeviceUnreachable
```

**解决方法**:
- 确认设备仍在开机状态
- 重新扫描设备
- 重启设备

#### 2. 检查设备是否被占用

```
日志: [ERROR] 连接失败: DeviceBusy
```

**解决方法**:
- 关闭其他蓝牙应用 (如手机蓝牙助手)
- 清除 Windows 蓝牙配对:
  1. Windows 设置 → 蓝牙和其他设备
  2. 找到设备 → 删除设备
  3. 重新扫描

#### 3. 信号干扰

```
日志: [ERROR] 连接超时
```

**解决方法**:
- 将设备移近电脑 (< 1 米)
- 远离 Wi-Fi 路由器
- 关闭附近的微波炉等电器
- 关闭其他蓝牙设备

### 连接后立即断开

**症状**: 显示"已连接"但立即断开

**可能原因**:
1. 特征值订阅失败
2. 设备固件异常
3. 权限问题

**解决方法**:

1. **检查日志**:
   ```
   [INFO] 设备已连接
   [ERROR] 订阅通知失败: AccessDenied
   ```

2. **以管理员身份运行**:
   - 右键应用程序 → 以管理员身份运行

3. **重置蓝牙服务**:
   ```powershell
   # 以管理员身份运行
   Stop-Service bthserv
   Start-Service bthserv
   ```

---

## 升级失败

### 文件验证失败

**症状**: 提示"固件文件格式错误"

**检查清单**:
- ✅ 文件扩展名为 `.ufw` 或 `.bfu`
- ✅ 文件大小 > 0
- ✅ 文件未损坏 (重新下载)
- ✅ 固件与设备型号匹配

**日志示例**:
```
[ERROR] 文件验证失败: InvalidFormat
[ERROR] 文件头签名不匹配: expected 0x55AA, got 0x0000
```

### 电量不足

**症状**: 提示"设备电量不足,无法升级"

**日志**:
```
[INFO] 设备信息: 型号=AC690X, 电量=25%, 充电=否
[ERROR] 升级失败: LowBattery (最低要求 30%)
```

**解决方法**:
- 充电至 > 30%
- 连接充电器后再升级

### 传输中断

**症状**: 升级进度条停止,提示"传输失败"

**常见原因**:

#### 设备断开连接

```
[INFO] 传输进度: 45% (512 KB / 1024 KB)
[ERROR] 设备断开连接
[ERROR] 升级失败: DeviceDisconnected
```

**解决方法**:
- 保持设备静止
- 确保电量充足
- 双备份固件可以断点续传

#### BLE 通信错误

```
[ERROR] 发送数据失败: WriteError
[ERROR] 特征值不可写
```

**解决方法**:
- 重启设备
- 重新连接
- 更新蓝牙驱动

### 设备拒绝升级

**症状**: 提示"设备拒绝进入升级模式"

**日志**:
```
[INFO] 发送进入升级模式命令
[ERROR] 设备返回错误: FirmwareNotSupported (0x03)
```

**错误码含义**:
- `0x01`: 电量不足
- `0x02`: 设备忙
- `0x03`: 不支持的固件
- `0xFF`: 未知错误

**解决方法**:
- 确认固件文件正确
- 检查固件版本是否兼容
- 查看设备官方升级说明

---

## 回连失败

**适用场景**: 单备份固件升级后

### 回连超时

**症状**: 显示"等待设备重启..."超过 30 秒

**日志**:
```
[INFO] 文件传输完成
[INFO] 等待设备重启并回连...
[WARN] 等待回连超时 (30 秒)
[ERROR] 升级失败: ReconnectTimeout
```

**可能原因**:
1. 设备重启时间过长
2. 设备 MAC 地址变化
3. 设备未正常重启

**解决方法**:

#### 延长等待时间

手动等待 1-2 分钟,然后:
1. 关闭并重启设备
2. 点击"开始扫描"
3. 查找设备
4. 如果找到,表示升级可能已成功

#### 检查设备状态

- 设备指示灯是否正常
- 设备是否发出声音
- 尝试手机连接设备

#### 查看详细日志

```
[DEBUG] 广播包: MAC=1234ABCD5678, Name=Unknown
[DEBUG] 匹配目标 MAC: 1234ABCD5678
[INFO] 找到目标设备,正在重连...
```

如果看不到 "找到目标设备",说明设备未广播或 MAC 变化。

---

## 性能问题

### 传输速度慢 (< 5 KB/s)

**症状**: 升级进度缓慢,预计需要 10+ 分钟

**日志**:
```
[INFO] 传输进度: 10% (3.2 KB/s)
```

**优化方法**:

#### 1. 改善信号质量

- 设备移近电脑 (< 50 cm)
- 避免障碍物
- 远离干扰源

#### 2. 使用更好的蓝牙适配器

- 蓝牙 5.0+ 适配器性能更好
- USB 3.0 接口优于 USB 2.0
- 外置适配器优于内置

#### 3. 优化系统设置

```powershell
# 禁用蓝牙节能模式
# 设备管理器 → 蓝牙适配器 → 属性 → 电源管理
# 取消勾选"允许计算机关闭此设备以节约电源"
```

### 应用程序内存占用高

**症状**: 任务管理器显示应用占用 > 200 MB 内存

**正常范围**: 50-100 MB

**可能原因**:
- 日志累积过多
- 内存泄漏 (请报告 Bug)

**解决方法**:
- 点击"清空日志"
- 重启应用
- 报告问题以便修复

---

## 应用程序问题

### 应用无法启动

**症状**: 双击应用无反应或闪退

**诊断步骤**:

#### 1. 检查运行时

自包含版本无需运行时,如果是依赖框架版本:

```powershell
dotnet --list-runtimes
```

应包含:
```
Microsoft.WindowsDesktop.App 9.0.x
```

如果缺失,下载安装: <https://dotnet.microsoft.com/download/dotnet/9.0>

#### 2. 检查事件查看器

1. Win + X → 事件查看器
2. Windows 日志 → 应用程序
3. 查找错误信息

#### 3. 以管理员身份运行

右键应用 → 以管理员身份运行

### 应用崩溃

**症状**: 使用过程中突然关闭

**收集崩溃信息**:

1. **日志文件**:
   - 位置: `%APPDATA%\JieLi.OTA\Logs\`
   - 查看最新日志

2. **Windows 错误报告**:
   - `%LOCALAPPDATA%\CrashDumps\`

3. **提交 Bug 报告**:
   - <https://github.com/PeiKeSmart/Ava.Ble/issues>
   - 附带日志和错误信息

---

## 日志分析

### 日志位置

```
%APPDATA%\JieLi.OTA\Logs\YYYY-MM-DD.log
```

### 日志级别

- `[DEBUG]`: 调试信息 (详细)
- `[INFO]`: 一般信息
- `[WARN]`: 警告 (不影响功能)
- `[ERROR]`: 错误 (影响功能)

### 关键日志示例

#### 成功的升级流程

```
[INFO] 开始扫描 BLE 设备...
[INFO] 发现设备: JL_Device (RSSI: -58)
[INFO] 扫描停止,共发现 3 个设备
[INFO] 开始连接设备: JL_Device
[INFO] 设备已连接
[INFO] 订阅通知成功
[INFO] 获取设备信息...
[INFO] 设备型号: AC690X, 电量: 85%, 版本: v2.3.0
[INFO] 开始升级: firmware_v2.4.0.ufw (1024 KB)
[INFO] 进入升级模式成功
[INFO] 开始传输文件...
[INFO] 传输进度: 25% (256 KB / 1024 KB, 15.2 KB/s)
[INFO] 传输进度: 50% (512 KB / 1024 KB, 16.1 KB/s)
[INFO] 传输进度: 75% (768 KB / 1024 KB, 15.8 KB/s)
[INFO] 传输进度: 100% (1024 KB / 1024 KB, 15.9 KB/s)
[INFO] 文件传输完成
[INFO] 查询升级结果...
[INFO] 升级成功!
[INFO] 重启设备...
[INFO] 升级完成,耗时: 68 秒
```

#### 常见错误模式

**连接超时**:
```
[INFO] 开始连接设备: JL_Device
[WARN] 连接超时,重试 (1/3)
[WARN] 连接超时,重试 (2/3)
[WARN] 连接超时,重试 (3/3)
[ERROR] 连接失败: 设备不可达
```

**传输中断**:
```
[INFO] 传输进度: 45% (460 KB / 1024 KB)
[ERROR] 设备断开连接
[ERROR] 升级失败: DeviceDisconnected
```

**电量不足**:
```
[INFO] 设备电量: 25%
[ERROR] 电量不足,无法升级 (最低 30%)
```

### 启用详细日志

编辑 `Config\Log.config`:

```xml
<add key="XTrace.Level" value="Debug" />
```

重启应用后会记录更详细的调试信息。

---

## 获取帮助

如果以上方法都无法解决问题:

### 1. 准备诊断信息

- [ ] 完整的日志文件
- [ ] 错误截图
- [ ] 系统信息:
  - Windows 版本
  - 蓝牙适配器型号
  - 应用版本
- [ ] 重现步骤

### 2. 提交 Issue

访问: <https://github.com/PeiKeSmart/Ava.Ble/issues>

使用模板:

```markdown
## 问题描述
简要描述遇到的问题

## 环境信息
- OS: Windows 10/11 (Build 版本)
- 蓝牙适配器: [型号]
- 应用版本: v1.0.0
- 设备型号: [杰理设备型号]

## 重现步骤
1. 启动应用
2. 点击...
3. 观察到...

## 预期行为
应该...

## 实际行为
但是...

## 日志
[附带日志文件]

## 截图
[如有必要]
```

### 3. 联系支持

- **Email**: support@peikesmart.com
- **响应时间**: 1-3 个工作日

---

**文档版本**: v1.0  
**最后更新**: 2025-11-04  
**适用版本**: JieLi OTA v1.0.0+
