# JieLi OTA 用户使用手册

## 📖 目录

- [系统要求](#系统要求)
- [安装指南](#安装指南)
- [首次使用](#首次使用)
- [设备扫描](#设备扫描)
- [固件升级](#固件升级)
- [日志管理](#日志管理)
- [常见问题](#常见问题)
- [故障排查](#故障排查)

---

## 系统要求

### 最低要求

- **操作系统**: Windows 10 版本 1809 (Build 17763) 或更高
- **处理器**: 双核 1.5 GHz
- **内存**: 4 GB RAM
- **硬盘空间**: 100 MB 可用空间
- **蓝牙**: 支持蓝牙 4.0 (BLE) 的适配器
- **运行时**: .NET 9.0 运行时 (自包含版本无需安装)

### 推荐配置

- **操作系统**: Windows 11
- **处理器**: 四核 2.0 GHz 或更高
- **内存**: 8 GB RAM 或更高
- **蓝牙**: 蓝牙 5.0+ 适配器

---

## 安装指南

### 方式一: 安装版 (推荐)

1. 从 [发布页面](https://github.com/PeiKeSmart/Ava.Ble/releases) 下载最新的 `.msi` 安装包
2. 双击运行安装程序
3. 按照安装向导提示完成安装
4. 首次运行时,Windows 可能会提示防火墙警告,请选择"允许访问"

### 方式二: 便携版

1. 下载 `.zip` 便携版
2. 解压到任意目录 (避免中文路径)
3. 双击 `JieLi.OTA.Desktop.exe` 运行

### 方式三: 需要运行时版本

1. 确保已安装 [.NET 9.0 运行时](https://dotnet.microsoft.com/download/dotnet/9.0)
2. 下载轻量级版本 (约 5MB)
3. 运行 `JieLi.OTA.Desktop.exe`

---

## 首次使用

### 1. 启动应用程序

双击桌面图标或从开始菜单启动 **JieLi OTA 固件升级工具**。

![启动界面](images/startup.png)

### 2. 检查蓝牙适配器

应用启动后会自动检测蓝牙适配器:

- ✅ **绿色状态**: 蓝牙适配器正常
- ⚠️ **黄色警告**: 蓝牙已关闭,请在 Windows 设置中开启
- ❌ **红色错误**: 未检测到蓝牙适配器

### 3. 准备固件文件

确保你已获取到目标设备的固件文件,通常为:

- `.ufw` 格式 - 杰理标准固件格式
- `.bfu` 格式 - 双备份固件格式

> ⚠️ **注意**: 使用错误的固件可能导致设备变砖,请务必确认固件与设备型号匹配!

---

## 设备扫描

### 开始扫描

1. 确保目标设备已开启并处于可发现状态
2. 点击左上角"**开始扫描**"按钮
3. 应用会自动扫描周围的 BLE 设备 (默认扫描 5 秒)

![设备扫描](images/scan-devices.png)

### 设备列表信息

扫描完成后,设备列表会显示:

| 列 | 说明 |
|---|------|
| **设备名称** | 设备广播的名称,未知设备显示为 `Unknown_XXXX` |
| **设备 ID** | 设备的 MAC 地址 (12 位十六进制) |
| **信号强度 (RSSI)** | 信号强度,数值越大信号越好 (通常 -40 ~ -90 dBm) |

### 设备识别

如果设备显示为 `Unknown_XXX`,这是正常现象,可能的原因:

- 设备未广播名称 (为节省电量)
- 设备名称在广播数据中未包含
- 设备类型由制造商数据决定

**如何识别目标设备?**

1. **信号强度**: 将手机靠近设备,RSSI 值最大的通常是目标设备
2. **MAC 地址**: 如果你知道设备的 MAC 地址,可以直接匹配
3. **设备类型**: 某些设备会显示类型前缀,如 `Apple_XXX`、`JL_XXX`

### 选择设备

- 点击列表中的设备行即可选中
- 选中的设备会高亮显示
- 再次点击可取消选择

### 停止扫描

- 点击"**停止扫描**"按钮可随时中断扫描
- 扫描会自动在 5 秒后停止

---

## 固件升级

### 1. 选择固件文件

1. 选中目标设备后,点击"**浏览**"按钮
2. 在文件选择对话框中选择固件文件 (`.ufw` 或 `.bfu`)
3. 文件路径会显示在文本框中

### 2. 确认设备信息

升级前请仔细确认:

- ✅ 设备名称/MAC 地址正确
- ✅ 固件文件与设备型号匹配
- ✅ 设备电量充足 (建议 > 30%)
- ✅ 设备距离适当 (建议 < 5m)

### 3. 开始升级

点击"**开始升级**"按钮,升级流程开始:

#### 阶段 1: 连接设备 (5-10 秒)

- 状态: **连接中...**
- 应用尝试连接选中的设备
- 成功后会显示"已连接"

#### 阶段 2: 获取设备信息 (2-5 秒)

- 状态: **获取设备信息...**
- 查询设备型号、固件版本、电量等信息
- 验证是否可以升级

#### 阶段 3: 文件校验 (1-3 秒)

- 状态: **校验固件文件...**
- 验证文件格式和完整性
- 检查文件大小和 CRC

#### 阶段 4: 进入升级模式 (2-5 秒)

- 状态: **进入升级模式...**
- 设备准备接收固件数据

#### 阶段 5: 传输文件 (30秒 - 5分钟)

- 状态: **传输中... (XX%))**
- 进度条显示实时进度
- 显示传输速度 (如 15.2 KB/s)
- 显示已传输/总大小 (如 128 KB / 1024 KB)

传输过程中**请勿**:
- ❌ 关闭应用程序
- ❌ 断开设备电源
- ❌ 移动设备位置
- ❌ 开启其他蓝牙应用

#### 阶段 6: 验证和重启

**双备份固件**:
- 状态: **查询升级结果...**
- 设备校验固件并返回结果
- 应用发送重启命令
- 升级完成

**单备份固件**:
- 状态: **等待设备重启...**
- 设备会自动断开连接并重启
- 应用自动扫描并重连设备 (最多等待 30 秒)
- 重连成功后完成升级

### 4. 升级完成

升级成功后:

- ✅ 状态显示"**升级成功**"
- ✅ 进度条达到 100%
- ✅ 日志显示"升级完成"

此时可以:
- 断开设备连接
- 升级其他设备
- 查看日志详情

### 5. 取消升级

升级过程中,点击"**取消升级**"按钮:

- 应用会尝试优雅地退出升级模式
- 已传输的数据会保留 (双备份模式支持断点续传)
- 设备会恢复到升级前的状态

> ⚠️ **注意**: 单备份模式下,取消升级可能导致设备处于异常状态,建议重新完整升级。

---

## 日志管理

### 日志窗口

右侧日志窗口实时显示升级过程的详细信息:

```
[20:47:27] 开始扫描 BLE 设备...
[20:47:27] 发现设备: JL_Device_001 (RSSI: -58)
[20:47:32] 扫描停止,共发现 5 个设备
[20:48:05] 开始连接设备: JL_Device_001
[20:48:08] 设备已连接,正在获取设备信息...
[20:48:10] 设备型号: AC690X, 固件版本: v2.3.1
[20:48:12] 开始固件升级...
[20:48:15] 进入升级模式成功
[20:48:16] 开始传输文件: firmware_v2.4.0.ufw (1024 KB)
[20:49:30] 文件传输完成,速度: 15.2 KB/s
[20:49:32] 升级成功!
```

### 日志操作

- **选择日志**: 点击并拖动鼠标可选择多行日志
- **复制日志**: 选中后按 `Ctrl+C` 复制
- **全选**: 按 `Ctrl+A` 选择全部日志
- **清空日志**: 点击"**清空日志**"按钮清除所有记录

### 日志文件

应用会自动将日志保存到文件:

- **位置**: `%APPDATA%\JieLi.OTA\Logs\`
- **格式**: `YYYY-MM-DD.log`
- **大小限制**: 单个文件最大 10 MB
- **保留时间**: 默认保留 30 天

---

## 常见问题

### Q1: 扫描不到设备?

**可能原因**:
1. 设备未开启或不在可发现状态
2. 蓝牙适配器已关闭
3. 设备距离太远 (> 10m)
4. 其他蓝牙应用占用适配器

**解决方法**:
- 确认设备已开启并进入配对模式
- 检查 Windows 蓝牙设置
- 将设备移近电脑 (< 5m)
- 关闭其他蓝牙应用

### Q2: 连接失败?

**可能原因**:
1. 设备已被其他应用连接
2. 信号干扰严重
3. 蓝牙适配器驱动问题

**解决方法**:
- 重启设备
- 重启蓝牙适配器
- 更新蓝牙驱动程序
- 清除 Windows 蓝牙配对记录

### Q3: 升级失败?

**可能原因**:
1. 固件文件与设备不匹配
2. 设备电量不足
3. 传输过程中断连接
4. 固件文件损坏

**解决方法**:
- 确认固件文件正确
- 充电至 > 30% 后重试
- 保持设备静止,避免移动
- 重新下载固件文件

### Q4: 单备份回连失败?

**可能原因**:
1. 设备重启时间过长 (> 30 秒)
2. 设备 MAC 地址变化
3. 设备未正常重启

**解决方法**:
- 等待更长时间 (1-2 分钟)
- 手动关闭并重启设备
- 重新扫描设备并选择
- 查看详细日志判断问题

### Q5: 传输速度慢?

**可能原因**:
1. 蓝牙适配器性能差
2. 信号干扰
3. MTU 协商失败

**解决方法**:
- 使用蓝牙 5.0+ 适配器
- 远离 Wi-Fi 路由器和其他干扰源
- 更新蓝牙驱动
- 减少同时运行的蓝牙设备

---

## 故障排查

### 收集诊断信息

如果遇到问题,请收集以下信息:

1. **系统信息**
   - Windows 版本: `Win + R` → `winver`
   - 蓝牙适配器型号

2. **日志文件**
   - 位置: `%APPDATA%\JieLi.OTA\Logs\`
   - 包含出错当天的日志

3. **错误截图**
   - 错误提示对话框
   - 日志窗口内容

4. **操作步骤**
   - 详细描述重现问题的步骤

### 提交问题

在 [GitHub Issues](https://github.com/PeiKeSmart/Ava.Ble/issues) 提交问题时,请包含:

- 问题描述
- 操作系统和应用版本
- 日志文件 (附件)
- 错误截图
- 重现步骤

### 联系支持

- **GitHub Issues**: https://github.com/PeiKeSmart/Ava.Ble/issues
- **Email**: support@peikesmart.com

---

## 附录

### 支持的固件格式

| 格式 | 扩展名 | 说明 |
|------|--------|------|
| 杰理标准格式 | `.ufw` | 通用固件格式 |
| 双备份格式 | `.bfu` | 支持断点续传 |

### 键盘快捷键

| 快捷键 | 功能 |
|--------|------|
| `F5` | 刷新设备列表 |
| `Ctrl+O` | 选择固件文件 |
| `Ctrl+L` | 清空日志 |
| `Ctrl+C` | 复制选中日志 |
| `Ctrl+A` | 全选日志 |
| `Esc` | 取消升级 |

### 性能参数

| 参数 | 典型值 | 说明 |
|------|--------|------|
| 扫描时间 | 5 秒 | 自动停止 |
| 连接超时 | 10 秒 | 可配置 |
| 传输速度 | 10-20 KB/s | 取决于适配器 |
| 回连超时 | 30 秒 | 单备份模式 |
| MTU 大小 | 512 字节 | 协商值 |

---

**文档版本**: v1.0  
**最后更新**: 2025-11-04  
**适用版本**: JieLi OTA v1.0.0+
